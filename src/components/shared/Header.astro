---
import Logo from "../../assets/logo.svg";
import type { Lang, LandingDict } from "../../i18n";
import ThemeToggle from "./ThemeToggle.astro";
import LanguageToggle from "./LanguageToggle.astro";
import MenuIcon from "./icons/MenuIcon.astro";
import MenuToCloseIcon from "./icons/MenuToCloseIcon.astro";
import CloseToMenuIcon from "./icons/CloseToMenuIcon.astro";

interface Props {
  lang: Lang;
  t: LandingDict;
  otherLangHref: string;
}

const { lang, t, otherLangHref } = Astro.props;
---

<header class="border-border/60 sticky top-0 z-30 border-b md:overflow-visible">
  <div
    class="bg-background/50 container flex items-center justify-between gap-4 py-4 backdrop-blur-xl"
  >
    <a
      href={lang === "ua" ? "/ua/" : "/"}
      class="flex shrink-0 items-center gap-2"
    >
      <Logo aria-label="SubEye logo" class="h-auto w-7" />
      <div class="flex flex-col">
        <span class="hidden text-sm font-semibold tracking-tight md:inline"
          >SubEye</span
        >
        <span class="text-muted-foreground hidden text-xs md:inline"
          >{t.nav.brandTagline}</span
        >
      </div>
    </a>

    <nav class="hidden items-center gap-8 text-sm md:flex">
      <a
        href="#product"
        class="text-muted-foreground hover:text-foreground transition-colors"
      >
        {t.nav.product}
      </a>
      <a
        href="#pricing"
        class="text-muted-foreground hover:text-foreground transition-colors"
      >
        {t.nav.pricing}
      </a>
      <a
        href="#faq"
        class="text-muted-foreground hover:text-foreground transition-colors"
      >
        {t.nav.faq}
      </a>
    </nav>

    <div class="flex items-center gap-2">
      <LanguageToggle href={otherLangHref} label={t.nav.switchTo} lang={lang} />
      <ThemeToggle />
      <a
        href="https://app.subeye.cc/auth/sign-in"
        class="border-border bg-background/60 text-muted-foreground hover:text-foreground hover:bg-muted/40 hidden items-center justify-center rounded-full border px-4 py-1.5 text-xs font-medium transition-colors md:inline-flex"
      >
        {t.nav.signin}
      </a>
      <a
        href="https://app.subeye.cc/auth/sign-up"
        class="bg-primary text-primary-foreground shadow-primary/40 hover:bg-primary/90 hidden items-center justify-center rounded-full px-4 py-1.5 text-xs font-medium shadow-lg transition-colors sm:px-5 sm:text-sm md:inline-flex"
      >
        {t.nav.signup}
      </a>
      <button
        id="mobile-menu-toggle"
        class="border-border bg-background/70 text-foreground hover:bg-muted/40 inline-flex size-9 cursor-pointer items-center justify-center rounded-full border transition-colors md:hidden"
        type="button"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <MenuIcon id="icon-initial" />
        <MenuToCloseIcon id="icon-m2c" class="hidden" />
        <CloseToMenuIcon id="icon-c2m" class="hidden" />
      </button>
    </div>
  </div>

  <div
    id="mobile-menu"
    class="bg-background/50 border-border/60 invisible absolute top-full left-0 w-full border-b opacity-0 backdrop-blur-xl transition-opacity duration-300 md:hidden"
  >
    <nav class="container flex flex-col space-y-4 py-6">
      <a href="#product" class="mobile-menu-link text-lg font-medium">
        {t.nav.product}
      </a>
      <a href="#pricing" class="mobile-menu-link text-lg font-medium">
        {t.nav.pricing}
      </a>
      <a href="#faq" class="mobile-menu-link text-lg font-medium">
        {t.nav.faq}
      </a>
      <hr class="border-border/40" />
      <div class="flex flex-col gap-3 pt-2">
        <a
          href="https://app.subeye.cc/auth/sign-in"
          class="border-border bg-background/60 text-muted-foreground flex h-11 items-center justify-center rounded-xl border text-sm font-medium"
        >
          {t.nav.signin}
        </a>
        <a
          href="https://app.subeye.cc/auth/sign-up"
          class="bg-primary text-primary-foreground flex h-11 items-center justify-center rounded-xl text-sm font-medium"
        >
          {t.nav.signup}
        </a>
      </div>
    </nav>
  </div>
</header>

<script>
  (() => {
    const toggle = document.getElementById("mobile-menu-toggle");
    const menu = document.getElementById("mobile-menu");
    const links = document.querySelectorAll(".mobile-menu-link");

    if (!toggle || !menu) return;

    const updateIcons = (isExpanded: boolean) => {
      const iconInitial = document.getElementById("icon-initial");
      const iconM2C = document.getElementById("icon-m2c");
      const iconC2M = document.getElementById("icon-c2m");

      if (iconInitial) iconInitial.classList.add("hidden");

      if (isExpanded) {
        if (iconM2C instanceof SVGSVGElement) {
          iconM2C.classList.remove("hidden");
          iconM2C.setCurrentTime(0);
        }
        if (iconC2M) iconC2M.classList.add("hidden");
      } else {
        if (iconM2C) iconM2C.classList.add("hidden");
        if (iconC2M instanceof SVGSVGElement) {
          iconC2M.classList.remove("hidden");
          iconC2M.setCurrentTime(0);
        }
      }
    };

    toggle.addEventListener("click", () => {
      const isExpanded = toggle.getAttribute("aria-expanded") === "true";
      const nextExpanded = !isExpanded;

      const handleToggle = () => {
        toggle.setAttribute("aria-expanded", nextExpanded.toString());
        updateIcons(nextExpanded);

        if (nextExpanded) {
          menu.classList.remove("invisible", "opacity-0");
          menu.classList.add("visible", "opacity-100");
          document.body.style.overflow = "hidden";
        } else {
          menu.classList.remove("visible", "opacity-100");
          menu.classList.add("invisible", "opacity-0");
          document.body.style.overflow = "";
        }
      };

      // @ts-ignore
      if (!document.startViewTransition) {
        handleToggle();
        return;
      }

      // @ts-ignore
      document.startViewTransition(() => handleToggle());
    });

    links.forEach((link) => {
      link.addEventListener("click", () => {
        const isExpanded = toggle.getAttribute("aria-expanded") === "true";
        if (isExpanded) {
          const handleClose = () => {
            toggle.setAttribute("aria-expanded", "false");
            updateIcons(false);
            menu.classList.remove("visible", "opacity-100");
            menu.classList.add("invisible", "opacity-0");
            document.body.style.overflow = "";
          };

          // @ts-ignore
          if (!document.startViewTransition) {
            handleClose();
            return;
          }

          // @ts-ignore
          document.startViewTransition(() => handleClose());
        }
      });
    });
  })();
</script>
